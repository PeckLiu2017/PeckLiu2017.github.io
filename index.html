<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Writing and Thinking">
<meta property="og:url" content="https://peckliu2017.github.io/index.html">
<meta property="og:site_name" content="Writing and Thinking">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Writing and Thinking">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://peckliu2017.github.io/"/>





  <title>Writing and Thinking</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Writing and Thinking</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://peckliu2017.github.io/2017/09/24/设计一个有-getMin（求最小值）功能的栈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peck Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Writing and Thinking">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/24/设计一个有-getMin（求最小值）功能的栈/" itemprop="url">设计一个有 getMin（求最小值）功能的栈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-24T23:46:14+08:00">
                2017-09-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="1-设计一个有-getMin（求最小值）功能的栈"><a href="#1-设计一个有-getMin（求最小值）功能的栈" class="headerlink" title="1.设计一个有 getMin（求最小值）功能的栈"></a>1.设计一个有 getMin（求最小值）功能的栈</h5><p>要求：</p>
<p>1.pop、push、getMin操作的时间复杂度都是O(1)。</p>
<p>2.设计的栈类型可以使用现成的栈结构。</p>
<p>分析：基本上就是用现成的栈结构封装一下设计一个新的栈类型。</p>
<p>解法：</p>
<p>1.先设计一个栈结构：​</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">class Stack</div><div class="line">  def initialize</div><div class="line">    @stack = []</div><div class="line">  end</div><div class="line"></div><div class="line">  def push(value)</div><div class="line">    @stack &lt;&lt; value</div><div class="line">  end</div><div class="line"></div><div class="line">  def pop</div><div class="line">    @stack.pop</div><div class="line">  end</div><div class="line"></div><div class="line">  def peek</div><div class="line">    @stack.last</div><div class="line">  end</div><div class="line"></div><div class="line">  def empty?</div><div class="line">    @stack.empty?</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>2.设计一个新的栈类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"># 题目要求：设计一个有 getMin（求最小值）功能的栈</div><div class="line">require_relative &apos;stack&apos;</div><div class="line">class MyStack1</div><div class="line">  # @stackData用来存储所有压入的值</div><div class="line">  # 同时</div><div class="line">  # 如果@stackMin为空</div><div class="line">  # 就压入跟@stackData一样的第一个值到栈顶</div><div class="line">  # 否则，将压入@stackData的值与栈顶的值比较</div><div class="line">  # 如果小于等于原来栈顶的值就压入，反之相反。</div><div class="line">  # 所以这个@stackMin的值从栈顶到栈底逐步变小</div><div class="line">  # 每次压入弹出的都是它的最小值</div><div class="line">  def initialize</div><div class="line">    @stackData = Stack.new</div><div class="line">    @stackMin = Stack.new</div><div class="line">  end</div><div class="line"></div><div class="line">  # 如果@stackMin为空</div><div class="line">  # 就把新数压入@stackMin之中</div><div class="line">  # 如果@stackMin不为空</div><div class="line">  # 但newNum小于@stackMin栈顶的值</div><div class="line">  # 就把newNum作为最小值放在@stackMin栈顶</div><div class="line">  # 同时把值压入@stackData栈顶</div><div class="line">  def push(newNum)</div><div class="line">    if @stackMin.empty?</div><div class="line">      @stackMin.push(newNum)</div><div class="line">    elsif newNum &lt;= self.get_min</div><div class="line">      @stackMin.push(newNum)</div><div class="line">    end</div><div class="line">    @stackData.push(newNum)</div><div class="line">  end</div><div class="line"></div><div class="line">  # 如果@stackMin为空</div><div class="line">  # 表示最小的值都没有</div><div class="line">  # 所以@stackData也为空</div><div class="line">  # 没有数据可以弹出</div><div class="line">  # 就抛出异常</div><div class="line">  # 否则记录@stackData中弹出的数字</div><div class="line">  # 如果@stackData中弹出的数字等于当前栈MyStack1实例的最小值也就是@stackMin栈顶的值</div><div class="line">  # 就同时弹出@stackMin栈顶的值</div><div class="line">  # 最后返回被从@stackData中弹出的值</div><div class="line">  def pop</div><div class="line">    if @stackMin.empty?</div><div class="line">      raise &apos;Your stack is empty&apos;</div><div class="line">    end</div><div class="line">    value = @stackData.pop</div><div class="line">    if value == self.get_min</div><div class="line">      @stackMin.pop</div><div class="line">    end</div><div class="line">    value</div><div class="line">  end</div><div class="line"></div><div class="line">  # 如果@stackMin为空</div><div class="line">  # 表示最小的值都没有</div><div class="line">  # 所以@stackData也为空</div><div class="line">  # 没有数据可以弹出</div><div class="line">  # 就抛出异常</div><div class="line">  # 否则返回它的位于栈顶的最小值</div><div class="line">  def get_min</div><div class="line">    if @stackMin.empty?</div><div class="line">      raise &apos;Your stack is empty&apos;</div><div class="line">    end</div><div class="line">    @stackMin.peek</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">stack1 = MyStack1.new</div><div class="line">stack1.push(3);  # 先把3加入栈中</div><div class="line">puts stack1.get_min # 得到最小值应该是3</div><div class="line">stack1.push(4); # 再把4加入栈中</div><div class="line">puts stack1.get_min # 3 &lt; 4,得到最小值还应该是3</div><div class="line">stack1.push(1); # 再把1加入栈中</div><div class="line">puts stack1.get_min # 1 &lt; 3,得到最小值应该是1</div><div class="line">puts stack1.pop # 将栈顶的1弹出</div><div class="line">puts stack1.get_min # 剩下的最小值应该是3</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://peckliu2017.github.io/2017/09/22/Ruby元编程笔记——编写代码的代码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peck Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Writing and Thinking">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/22/Ruby元编程笔记——编写代码的代码/" itemprop="url">Ruby元编程笔记——编写代码的代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-22T23:53:17+08:00">
                2017-09-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="任务：写一个类宏"><a href="#任务：写一个类宏" class="headerlink" title="任务：写一个类宏"></a>任务：写一个类宏</h4><p>这个类宏与 attr_accessor 类似，名字叫 attr_checked 方法，它有如下特征：</p>
<ol>
<li>它会创建经过检验的属性</li>
<li>接受属性名和代码块，代码块用来校验，如果对一个属性赋值，而代码块没有返回<code>true</code>，就会抛出异常。</li>
<li>attr_checked并不在每个类中都可用，因为它的初衷并不是把标准库搞的乱七八糟，只有当一个类包含CheckedAttributes模块时才能使用这个方法。</li>
</ol>
<h4 id="开发步骤："><a href="#开发步骤：" class="headerlink" title="开发步骤："></a>开发步骤：</h4><ol>
<li><p>使用 eval() 编写一个名为 add_checked_attribute() 的内核方法，为类添加一个最简单的经过校验的属性，比如说 age 。</p>
<p>这里用 eval 方法（背景知识2，3，4）是为了快速通过测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">require &apos;test/unit&apos;</div><div class="line"></div><div class="line">class Person; end</div><div class="line"></div><div class="line">class TestCheckedAttribute &lt; Test::Unit::TestCase</div><div class="line">  def setup</div><div class="line">    add_checked_attribute(Person, :age)</div><div class="line">    @bob = Person.new</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_accepts_valid_values</div><div class="line">    @bob.age = 20</div><div class="line">    assert_equal 20, @bob.age</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_refuses_nil_values</div><div class="line">    assert_raises RuntimeError, &apos;Invalid attribute&apos; do</div><div class="line">      @bob.age = nil</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_refuses_false_values</div><div class="line">    assert_raises RuntimeError, &apos;Invalid attribute&apos; do</div><div class="line">      @bob.age = false</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">def add_checked_attribute(klass, attribute)</div><div class="line">  eval &quot;</div><div class="line">    class #&#123;klass&#125;</div><div class="line">      def #&#123;attribute&#125;=(value)</div><div class="line">        raise &apos;Invalid attribute&apos; unless value</div><div class="line">        @#&#123;attribute&#125; = value</div><div class="line">      end</div><div class="line"></div><div class="line">      def #&#123;attribute&#125;()</div><div class="line">        @#&#123;attribute&#125;</div><div class="line">      end</div><div class="line">    end</div><div class="line">  &quot;</div><div class="line">end</div></pre></td></tr></table></figure>
<p>这里的 add_checked_attribute 方法为什么要仿照 attr_accessor 的创建的读写拟态方法呢？也许因为方法的核心内容就是读写吧。在明确了读写对象的基础上才有了比较等其它操作。所以第一步的核心是先开发出读写方法。</p>
</li>
<li><p>重构 add_checked_attribute() 方法，去掉 eval() 。</p>
<p>因为 eval 的缺点（背景知识3），接下来去掉 eval() 。</p>
<p>不用 eval() 方法，就无法使用代码字符串，继续使用 class 关键字，因为 class 不接受变量作为类名，<code>#{klass}</code>和的值无法动态传入。此时，可以用 class_eval 方法进入类的作用域。</p>
<p>同时在定义方法时也不能用 def 了，因为只有在运行时才知道方法的名字。这里可以用<code>defind_method</code> 来动态定义方法。至于操作实例变量，可以用 instance_variable_get 和 instance_variable_set 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">require &apos;test/unit&apos;</div><div class="line">class Person; end</div><div class="line">class TestCheckedAttribute &lt; Test::Unit::TestCase</div><div class="line">  def setup</div><div class="line">    add_checked_attribute(Person, :age)</div><div class="line">    @bob = Person.new</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_accepts_valid_values</div><div class="line">    @bob.age = 20</div><div class="line">    assert_equal 20, @bob.age</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_refuses_nil_values</div><div class="line">    assert_raises RuntimeError, &apos;Invalid attribute&apos; do</div><div class="line">      @bob.age = nil</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_refuses_false_values</div><div class="line">    assert_raises RuntimeError, &apos;Invalid attribute&apos; do</div><div class="line">      @bob.age = false</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">def add_checked_attribute(klass, attribute)</div><div class="line">  klass.class_eval do</div><div class="line">    define_method &quot;#&#123;attribute&#125;=&quot; do |value|</div><div class="line">      raise &apos;Invalid attribute&apos; unless value</div><div class="line">      instance_variable_set(&quot;@#&#123;attribute&#125;&quot;, value)</div><div class="line">    end</div><div class="line"></div><div class="line">    define_method attribute do</div><div class="line">      instance_variable_get &quot;@#&#123;attribute&#125;&quot;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
</li>
<li><p>通过块来校验属性。</p>
<p>目前代码只能简单地对赋值 nil 或 false 的情况抛出异常，没有代码块验证的灵活。这里通过 &amp;validation 来做代码块验证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">require &apos;test/unit&apos;</div><div class="line">class Person; end</div><div class="line">class TestCheckedAttribute &lt; Test::Unit::TestCase</div><div class="line">  def setup</div><div class="line">    add_checked_attribute(Person, :age) &#123;|v| v &gt;= 18 &#125;</div><div class="line">    @bob = Person.new</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_accepts_valid_values</div><div class="line">    @bob.age = 20</div><div class="line">    assert_equal 20, @bob.age</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_refuses_invalid_values</div><div class="line">    assert_raises RuntimeError, &apos;Invalid attribute&apos; do</div><div class="line">      @bob.age = 17</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">def add_checked_attribute(clazz, attribute, &amp;validation)</div><div class="line">  clazz.class_eval do</div><div class="line">    define_method &quot;#&#123;attribute&#125;=&quot; do |value|</div><div class="line">      raise &apos;Invalid attribute&apos; unless validation.call(value)</div><div class="line">      instance_variable_set(&quot;@#&#123;attribute&#125;&quot;, value)</div><div class="line">    end</div><div class="line"></div><div class="line">    define_method attribute do</div><div class="line">      instance_variable_get &quot;@#&#123;attribute&#125;&quot;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
</li>
<li><p>将 add_checked_attribute() 改名为 attr_checked 的类宏，它对所有类可用。</p>
<p>这意味着应该定义一个可以在类定义中使用的方法，另外新方法不能像  add_checked_attribute() 一样接受类名作为参数，应该只接受属性名作为参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">require &apos;test/unit&apos;</div><div class="line">class Person</div><div class="line">  attr_checked: age do |v|</div><div class="line">    v &gt;= 18</div><div class="line">  end</div><div class="line">end</div><div class="line">class TestCheckedAttribute &lt; Test::Unit::TestCase</div><div class="line">  def setup</div><div class="line">    @bob = Person.new</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_accepts_valid_values</div><div class="line">    @bob.age = 20</div><div class="line">    assert_equal 20, @bob.age</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_refuses_invalid_values</div><div class="line">    assert_raises RuntimeError, &apos;Invalid attribute&apos; do</div><div class="line">      @bob.age = 17</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">class Class</div><div class="line">  def attr_checked(attribute, &amp;validation)</div><div class="line">    define_method &quot;#&#123;attribute&#125;=&quot; do |value|</div><div class="line">      raise &apos;Invalid attribute&apos; unless validation.call(value)</div><div class="line">      instance_variable_set(&quot;@#&#123;attribute&#125;&quot;, value)</div><div class="line">    end</div><div class="line"></div><div class="line">    define_method attribute do</div><div class="line">      instance_variable_get &quot;@#&#123;attribute&#125;&quot;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
</li>
<li><p>写一个模块，通过钩子方法（背景知识5）为指定的类添加 attr_checked 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">module CheckedAttributes</div><div class="line">  def self.included(base)</div><div class="line">    base.extend ClassMethods</div><div class="line">  end</div><div class="line"></div><div class="line">  module ClassMethods</div><div class="line">    def attr_checked(attribute, &amp;validation)</div><div class="line">      define_method &quot;#&#123;attribute&#125;=&quot; do |value|</div><div class="line">        raise &apos;Invalid attribute&apos; unless validation.call(value)</div><div class="line">        instance_variable_set(&quot;@#&#123;attribute&#125;&quot;, value)</div><div class="line">      end</div><div class="line"></div><div class="line">      define_method attribute do</div><div class="line">        instance_variable_get &quot;@#&#123;attribute&#125;&quot;</div><div class="line">      end</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">require &apos;test/unit&apos;</div><div class="line">class Person</div><div class="line">  include CheckedAttributes</div><div class="line">  attr_checked :age do |v|</div><div class="line">    v &gt;= 18</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">class TestCheckedAttributes &lt; Test::Unit::TestCase</div><div class="line">  def setup</div><div class="line">    @bob = Person.new</div><div class="line">  end</div><div class="line"></div><div class="line">  def test_accepts_valid_values</div><div class="line">    @bob.age = 18</div><div class="line">    assert_equal 18, @bob.age</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
</li>
</ol>
<p>最后的结果是，公用验证代码放在 CheckedAttributes 模块中，类宏 attr_checked 验证条件在类中使用，测试液运行正常。代码结构干净利索。</p>
<h4 id="背景知识补充："><a href="#背景知识补充：" class="headerlink" title="背景知识补充："></a>背景知识补充：</h4><h5 id="1-绑定对象"><a href="#1-绑定对象" class="headerlink" title="1.绑定对象"></a>1.绑定对象</h5><p>Binding 就是一个用对象表示的完整作用域。可以通过 Binding 对象和来捕获并带走当前作用域，然后使用 eval 来计算结果，实现类似于闭包的操作。</p>
<p>Binding.pry会在当前绑定上打开一个Ruby解释器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">class MyClass</div><div class="line">  def my_method</div><div class="line">    @x = 1</div><div class="line">    binding</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">b = MyClass.new.my_method</div><div class="line">puts eval &quot;@x&quot;, b</div><div class="line"></div><div class="line">class AnotherClass</div><div class="line">  def my_method</div><div class="line">    eval &apos;self&apos;, TOPLEVEL_BINDING</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">puts AnotherClass.new.my_method #=&gt; main</div></pre></td></tr></table></figure>
<h5 id="2-eval-的用处"><a href="#2-eval-的用处" class="headerlink" title="2.eval 的用处"></a>2.eval 的用处</h5><p>eval 方法自带共享作用域（和变量）的功能，能够自动衔接目标类的上下文。</p>
<p>从外部传入一个任意的代码字符串给 eval 方法，这样就可以创建一个简单的Ruby解释器。很多Ruby解释器都使用了 eval 方法。</p>
<h5 id="3-eval-的麻烦"><a href="#3-eval-的麻烦" class="headerlink" title="3.eval 的麻烦"></a>3.eval 的麻烦</h5><p>1.不支持编辑器的功能特性，比如语法高亮和自动完成。</p>
<p>2.难以阅读和修改</p>
<p>3.Ruby执行字符串前不会进行语法检查</p>
<p>4.安全性不好——有可能会被代码注入</p>
<h5 id="4-防止代码注入："><a href="#4-防止代码注入：" class="headerlink" title="4.防止代码注入："></a>4.防止代码注入：</h5><p>1.限制 eval 方法只执行自己写的代码字符串。</p>
<p>2.禁用 eval 方法。</p>
<p>3.识别污染对象和设置安全级别。</p>
<h5 id="5-钩子方法"><a href="#5-钩子方法" class="headerlink" title="5.钩子方法"></a>5.钩子方法</h5><p>Ruby 提供的钩子方法种类繁多，覆盖了对象模型中绝大多数事件。当中这些事件发生（如被包含，扩展，方法增加删除等），就会触发它们。</p>
<p>通过覆写钩子方法如 Module#included() 方法，使得当一个模块被包含时执行额外的代码。它跟环绕别名所起到的作用有点像。</p>
<p>就算不覆写，也可以借助环绕别名把普通方法变成钩子方法。</p>
<h4 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h4><p>用平常心对待代码，它应该简洁而清晰，而不是晦涩难懂。</p>
<p>要有智慧忘掉所学的东西，根本没有什么元编程，只有编程而已。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://peckliu2017.github.io/2017/09/22/Ruby元编程笔记——类定义/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peck Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Writing and Thinking">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/22/Ruby元编程笔记——类定义/" itemprop="url">Ruby元编程笔记——类定义</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-22T10:10:48+08:00">
                2017-09-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本章内容理解：讲了Ruby对象模型，并且介绍了几种依赖于此模型的技术。</p>
<p>在Java和C#等语言中，直到你创建了该类的一个对象，然后调用对象的方法才会有实际的工作。</p>
<p>在Ruby中，类的定义有所不同。当使用class关键字时，并非是在指定对象未来的行为方式，相反，实际上是在运行代码。</p>
<h5 id="Ruby对象模型介绍以及七条规则："><a href="#Ruby对象模型介绍以及七条规则：" class="headerlink" title="Ruby对象模型介绍以及七条规则："></a>Ruby对象模型介绍以及七条规则：</h5><p>1.只有一种对象——要么是普通对象，要么是模块。</p>
<p>类就是对象，是class类的一个实例。类也是一个增强的模块，比模块多了new、allocate、superclass三个方法。</p>
<p>普通对象不可以使用new方法再建立一个实例，模块也是。</p>
<p>2.只有一种方法——它存在于一个模块中，通常是一个类中。</p>
<p>无论是类或模块的实例方法，类方法，都存在于类或模块中。单件方法比较特殊，但也存在于单件类中。</p>
<p>3.只有一种模块——可以是一个普通模块、一个类或者单件类</p>
<p>模块可以是普通模块，可以是一个类，即增强的模块。同时一个普通的模块无法被继承。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">module M</div><div class="line">  M = 1</div><div class="line">end</div><div class="line"></div><div class="line">module D &lt; M</div><div class="line">  D = 1</div><div class="line">end</div><div class="line"></div><div class="line">SyntaxError: (irb):15: syntax error, unexpected &apos;&lt;&apos; module D &lt; M</div><div class="line"># 一个普通的模块无法被继承。</div></pre></td></tr></table></figure>
<p>4.每个对象都有自己”真正的类”，要么是一个普通类，要么是一个单件类。</p>
<p>前面好理解，至于”要么是一个单件类”这句话，可以通过这个例子理解一下：</p>
<p><code>instance_eval</code>方法把当前类改成了接收者s1的单件类。只有s1自己一个对象可以使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">s1, s2 = &quot;abc&quot;, &quot;def&quot;</div><div class="line">s1.instance_eval do  </div><div class="line">  def swoosh!; reverse; end</div><div class="line">end</div><div class="line"></div><div class="line">s1.swoosh!  #=&gt; &quot;cba&quot;</div><div class="line">s2.respond_to?(:swoosh!)   #=&gt; false</div></pre></td></tr></table></figure>
<p>5.除了BasicObject，任何类只有一条向上的、直到BasicObject的祖先链。</p>
<p>6.一个(普通)对象(区别于类这种对象)的单件类的超类是这个对象的类，一个类的单件类的超类是这个类的超类的单件类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">class C</div><div class="line">  class &lt;&lt; self</div><div class="line">    def a_class_method</div><div class="line">      &apos;C#a_class_method()&apos;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">class D &lt; C; end</div><div class="line"></div><div class="line">obj = D.new</div><div class="line"></div><div class="line"># 一个(普通)对象的单件类的超类是这个对象的类</div><div class="line">puts obj.singleton_class.superclass #=&gt; D</div><div class="line"># 一个类的单件类的超类是这个类的超类的单件类</div><div class="line">puts C.singleton_class.superclass #=&gt;  #&lt;Class:Object&gt;</div><div class="line">puts C.superclass.singleton_class #=&gt;  #&lt;Class:Object&gt;</div></pre></td></tr></table></figure>
<p>7.调用一个方法时，Ruby先向右迈一步进入接受者真正的类，然后向上进入祖先链。这就是Ruby查找方法的方式。</p>
<p>如果它有单件类(规则4)，查找会从单件类开始。</p>
<p>为什么Ruby要以这种方式来组织对象模型？——这样就能在子类中调用父类的类方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class C</div><div class="line">  class &lt;&lt; self  # 这行代码表示开始为C定义类方法</div><div class="line">    def a_class_method</div><div class="line">      &apos;C#a_class_method()&apos;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">class D &lt; C; end</div><div class="line">puts D.a_class_method #=&gt; C#a_class_method() #=&gt;在子类D中调用父类C的类方法。</div></pre></td></tr></table></figure>
<h4 id="依赖Ruby对象模型而来的技术概念："><a href="#依赖Ruby对象模型而来的技术概念：" class="headerlink" title="依赖Ruby对象模型而来的技术概念："></a>依赖Ruby对象模型而来的技术概念：</h4><h5 id="1-在不知道类名的情况下打开一个类："><a href="#1-在不知道类名的情况下打开一个类：" class="headerlink" title="1.在不知道类名的情况下打开一个类："></a>1.在不知道类名的情况下打开一个类：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">def add_method_to(a_class)    </div><div class="line">	a_class.class_eval do       </div><div class="line">		def m;</div><div class="line">			&apos;Hello!&apos;;</div><div class="line">		end    </div><div class="line">	end</div><div class="line">end</div><div class="line"></div><div class="line">add_method_to String</div><div class="line">&quot;abc&quot;.m     #  &quot;Hello!&quot;</div></pre></td></tr></table></figure>
<p>这里给String类增加了一个m方法。</p>
<blockquote>
<h5 id="class-eval和class的区别："><a href="#class-eval和class的区别：" class="headerlink" title="class_eval和class的区别："></a><code>class_eval</code>和<code>class</code>的区别：</h5><p>class_eval使用扁平作用域，当前的绑定依然可见。</p>
<p>class则打开一个新的作用域，当前的绑定不可见。</p>
<h5 id="class-eval和instance-eval的区别："><a href="#class-eval和instance-eval的区别：" class="headerlink" title="class_eval和instance_eval的区别："></a><code>class_eval</code>和<code>instance_eval</code>的区别：</h5><p>一般用instance_eval方法打开非类的对象，用class_eval方法打开类定义。</p>
<p>当前类</p>
<p>不管Ruby程序处于哪个位置，总存在一个当前对象：self。同样，也总有一个当前类或当前模块的存在，定义一个方法时，那个方法将成为当前类的一个实例方法。</p>
</blockquote>
<h5 id="2-类实例变量和类变量"><a href="#2-类实例变量和类变量" class="headerlink" title="2.类实例变量和类变量"></a>2.类实例变量和类变量</h5><p>类实例变量是Class类的实例——即继承Class的一般类的实例变量。一般类相对于Class类来说也就是个普通对象。它定义于一般类充当self的时刻，所以只能被它本身的类访问，不能被它的实例或者子类访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">class C</div><div class="line">  @@v1 = 1   # 类变量以@@开头</div><div class="line">  @v2 = 2  # 这是类实例变量</div><div class="line"></div><div class="line">  def my_method1;</div><div class="line">    puts  @@v1</div><div class="line">  end</div><div class="line"></div><div class="line">  def my_method2;</div><div class="line">    puts  @v2</div><div class="line">  end</div><div class="line"></div><div class="line">end</div><div class="line"></div><div class="line">class D &lt; C    </div><div class="line">  def my_method1;</div><div class="line">    puts  @@v1</div><div class="line">  end</div><div class="line"></div><div class="line">  def my_method2;</div><div class="line">    puts  @v2</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">obj1 = C.new</div><div class="line">obj1.my_method1 #=&gt; 1</div><div class="line">obj1.my_method2 #=&gt; nil # 类实例变量不能被它的实例或者子类访问</div><div class="line"></div><div class="line">obj2 = D.new</div><div class="line">obj2.my_method1 #=&gt; 1</div><div class="line">obj2.my_method2 #=&gt; nil # 类实例变量不能被它的实例或者子类访问</div><div class="line"></div><div class="line">obj1.my_method1 #=&gt; 3</div><div class="line"># @@v1定义于main的上下文，属于main的类object</div><div class="line"># 所以也属于object所有的后代</div><div class="line"># 所以在C中定义的@@v1因为D#my_method1被改为3</div><div class="line"># 也因为这个特性，类变量可以在别处被修改，使用它的情况很少，使用类实例变量较多。</div></pre></td></tr></table></figure>
<h5 id="3-类宏"><a href="#3-类宏" class="headerlink" title="3.类宏"></a>3.类宏</h5><p>类宏可以为任何ruby对象创建属性。</p>
<p>在给对象创造属性的时候用<code>Module#attr_ accessor()</code>，给类创造属性时用单件方法。</p>
<p>属性实际上只是一对方法，如果在单件类中定义了这些方法，那么他实际上会成为类方法。</p>
<p>Ruby对象并没有属性。如果希望有一些像属性的东西，就得定义两个拟态方法：一个读方法和一个写方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># class_definitions/attr.rb</div><div class="line">class MyClass    </div><div class="line">	def my_attribute=(value)       </div><div class="line">		@my_attribute = value    </div><div class="line">	end</div><div class="line"></div><div class="line">    def my_attribute       </div><div class="line">        @my_attribute    </div><div class="line">    end</div><div class="line">end</div><div class="line"></div><div class="line">obj = MyClass.new</div><div class="line">obj.my_attribute = &apos;x&apos;</div><div class="line">obj.my_attribute             #  &quot;x&quot;</div></pre></td></tr></table></figure>
<ul>
<li>写这样的方法（也叫访问器）很快就让人感到枯燥。可以通过Module#attr_ accessor()则可以生成读写方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class MyClass    </div><div class="line">	attr_accessor :my_attribute</div><div class="line">end</div></pre></td></tr></table></figure>
<ul>
<li>为普通Ruby对象创建属性：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">class MyClass</div><div class="line">  attr_accessor :b</div><div class="line">end</div><div class="line"></div><div class="line">obj = MyClass.new</div><div class="line">obj.a = 2</div><div class="line">puts obj.a #=&gt; 2</div></pre></td></tr></table></figure>
<ul>
<li>为类创建属性</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class MyClass; end</div><div class="line"></div><div class="line">class Class</div><div class="line">  attr_accessor :a</div><div class="line">end</div><div class="line"></div><div class="line">MyClass.b = 42</div><div class="line">puts MyClass.b #=&gt; 42</div></pre></td></tr></table></figure>
<p>但这样做会让所有继承Class类的类都拥有这个属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 接上段代码</div><div class="line">MyClass1.b = 42</div><div class="line">puts MyClass1.b #=&gt; 42</div></pre></td></tr></table></figure>
<p>所以考虑下一种做法：</p>
<ul>
<li>将类属性创建在该类的单件类中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">class MyClass</div><div class="line">  class &lt;&lt; self</div><div class="line">    attr_accessor :c</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">MyClass.c = &apos;It works!&apos;</div><div class="line">puts MyClass.c #=&gt; 42</div><div class="line"></div><div class="line">MyClass1.c = &apos;It works!&apos;</div><div class="line">puts MyClass1.c #=&gt; 42</div><div class="line"># =&gt; undefined method `c=&apos; for MyClass1:Class (NoMethodError)</div></pre></td></tr></table></figure>
<h5 id="4-单件类"><a href="#4-单件类" class="headerlink" title="4.单件类"></a>4.单件类</h5><p>每个单件类只有一个实例，而且不能被继承。单件类也是一个对象单件方法的存活之所。</p>
<ul>
<li>单件方法适合在什么情况下使用</li>
</ul>
<p>​       仅仅针对于个别使用次数很少的对象。也就是用来增强某个类。</p>
<p>​       类方法的实质是一个类的单件方法。</p>
<p>​       类方法的实质就是：它们是一个类的单件方法。为什么要是单件方法呢？——只是这一个对象（类）能用它。</p>
<ul>
<li>怎样进入单件类？</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class &lt;&lt; an_object</div><div class="line"> # ...</div><div class="line">end</div></pre></td></tr></table></figure>
<p>如果对象有单件类，Ruby不是从它所在的类开始查找，而是从对象的单件类开始查找方法。</p>
<p>在单件类中，有一种运用情况是类方法，下面来看看类方法。</p>
<h5 id="5-三种定义类方法的方法："><a href="#5-三种定义类方法的方法：" class="headerlink" title="5.三种定义类方法的方法："></a>5.三种定义类方法的方法：</h5><h5 id="类扩展"><a href="#类扩展" class="headerlink" title="类扩展"></a>类扩展</h5><p>通过向类的单件类中增加模块来定义方法。</p>
<ul>
<li>直接打开类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">module MyModule</div><div class="line">  def my_method; &quot;Hello&quot;; end</div><div class="line">end</div><div class="line"></div><div class="line">class MyClass</div><div class="line">  class &lt;&lt; self</div><div class="line">    include MyModule</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">puts MyClass.my_method  #=&gt; &quot;Hello&quot;</div></pre></td></tr></table></figure>
<ul>
<li>include方法扩展：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">module MyModule</div><div class="line">  def my_method; &quot;Hello&quot;; end</div><div class="line">end</div><div class="line"></div><div class="line">obj = Object.new</div><div class="line"></div><div class="line">class &lt;&lt; obj</div><div class="line">  include MyModule</div><div class="line">end</div><div class="line"></div><div class="line">puts obj.my_method  #=&gt; &quot;Hello&quot;</div><div class="line">puts obj.singleton_methods  #=&gt; &quot;[:my_method]&quot;</div></pre></td></tr></table></figure>
<ul>
<li>extend方法扩展：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">module MyModule</div><div class="line">  def my_method; &quot;Hello&quot;; end</div><div class="line">end</div><div class="line"></div><div class="line">obj = Object.new</div><div class="line">obj.extend MyModule</div><div class="line">puts obj.my_method  #=&gt; &quot;Hello&quot;</div><div class="line"></div><div class="line">class MyClass</div><div class="line">  extend MyModule</div><div class="line">end</div><div class="line"></div><div class="line">puts MyClass.my_method  #=&gt; &quot;Hello&quot;</div></pre></td></tr></table></figure>
<h5 id="6-方法包装器"><a href="#6-方法包装器" class="headerlink" title="6.方法包装器"></a>6.方法包装器</h5><p>有一个不能直接修改的方法，而我希望为这个方法包装额外的特性，这样所有的客户端都能自动获得这个额外特性。要明白方法包装器，先明白方法别名：</p>
<ul>
<li>方法别名</li>
</ul>
<p>有点绕，先看较简单的初级形式，它只输出一个字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">class MyClass</div><div class="line">  def my_method</div><div class="line">    &apos;my_method()&apos;</div><div class="line">  end</div><div class="line">  alias_method :m, :my_method</div><div class="line">  alias_method :m2, :m</div><div class="line">end</div><div class="line"></div><div class="line">obj = MyClass.new</div><div class="line">puts obj.my_method</div><div class="line">puts obj.m</div><div class="line">puts obj.m2</div></pre></td></tr></table></figure>
<p>先给方法命名一个别名，然后重定义了它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class String</div><div class="line">  alias_method :real_length, :length</div><div class="line"></div><div class="line">  def length</div><div class="line">    real_length &gt; 5 ? &apos;long&apos; : &apos;short&apos;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">puts &quot;War and Peace&quot;.length</div><div class="line">puts &quot;War and Peace&quot;.real_length</div></pre></td></tr></table></figure>
<p>当调用<code>real_length</code>时，它会调用原来的<code>length</code>并输出结果。</p>
<p>调用<code>length</code>时，它会通过<code>real_length</code>与5比较，然后得到结果。同样的，调用<code>real_length</code>时，它会调用原来的<code>length</code>并输出结果。</p>
<ul>
<li>定义环绕别名</li>
</ul>
<p>​       1.给方法定义一个别名</p>
<p>​       2.重定义这个方法</p>
<p>​       3.在新的方法中调用老的方法</p>
<p>​       它的作用本质是往老方法中加入一些代码。它是一种方法包装器，下面来看看更多的方法包装器：</p>
<ul>
<li>用细化封装器代替环绕别名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">module StringRefinement</div><div class="line">  refine String do</div><div class="line">    def length</div><div class="line">      super &gt; 5 ? &apos;long&apos; : &apos;short&apos;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">using StringRefinement</div><div class="line">puts &quot;War and Peace&quot;.length #=&gt; &quot;long&quot;</div></pre></td></tr></table></figure>
<p>​       这里的只用一个<code>super</code>关键字调用原来的方法并与5比较得出结果。</p>
<p>​       细化封装器的作用范围只到文件末尾处，比环绕别名安全，因为环绕别名是全局性的。</p>
<p>​       不过还有一种方法包装的技术，使用<code>module_prepend</code>方法：</p>
<ul>
<li>下包含包装器：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">module ExplicitString</div><div class="line">  def length</div><div class="line">    super &gt; 5 ? &apos;long&apos; : &apos;short&apos;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">String.class_eval do</div><div class="line">  prepend ExplicitString</div><div class="line">end</div><div class="line"></div><div class="line">puts &quot;War and Peace&quot;.length #=&gt; &quot;long&quot;</div></pre></td></tr></table></figure>
<p>​       它也是一种局部化的方法包装器，不过一般认为它比细化包装器和环绕别名都更清晰。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://peckliu2017.github.io/2017/09/20/Ruby元编程笔记——代码块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peck Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Writing and Thinking">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/20/Ruby元编程笔记——代码块/" itemprop="url">Ruby元编程笔记——代码块</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-20T22:59:12+08:00">
                2017-09-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本章内容理解：讲了打破封装，随时随地增加或修改变量和方法的技术。</p>
<p>代码块作为“程序中的基本操作元素之一”，是实现下面这些操作的基础：</p>
<p>代码块是闭包，闭包的作用在于，让变量在指定的作用域发挥作用，不会受到作用域外变量的干扰。也在于将变量带到别的作用域。</p>
<p>接下来依次<strong>记录块，作用域以及打破封装共享变量的技术操作。</strong></p>
<h4 id="块"><a href="#块" class="headerlink" title="块"></a>块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def a_method(a, b)</div><div class="line">	a + yield(a, b)</div><div class="line">end</div><div class="line"></div><div class="line">a_method(1, 2) &#123;|x, y| (x + y) * 3 &#125;  #=&gt;  10</div></pre></td></tr></table></figure>
<p>通常情况下，如果只有一行，代码块可以通过大括号定义，比如上面的<code>{|x, y| (x + y) * 3 }</code>，若有多行，可以通过<code>def...end</code>来定义。</p>
<p>在调用一个方法时才可以定义一个块。块会被直接传递给这个方法，该方法可以用yield关键字调用<code>这个块</code>。</p>
<p>通过<code>Kernel#block_given?()</code>方法来询问当前的方法调用是否包含块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def a_method    </div><div class="line">	return yield if block_given?    </div><div class="line">	&apos;no block&apos;</div><div class="line">end</div><div class="line"></div><div class="line">a_method                               #  &quot;no block&quot;</div><div class="line">a_method &#123; &quot;here&apos;s a block!&quot; &#125;         #  &quot;here&apos;s a block!&quot;</div></pre></td></tr></table></figure>
<p>可以运行的代码由两部分组成：代码本身和一组绑定。</p>
<p>从上面两个例子可以看出，代码块是闭包，它可以把变量带出原来的作用域，带入<code>a_method</code>中执行。代码块不能孤立地运行，它需要一个执行环境：局部变量，实例变量，<code>self</code>等。可运行的代码包括两部分：代码本身和一组绑定。那么代码块是如何获得一组绑定的呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def my_method    </div><div class="line">    x = &quot;Goodbye&quot;   </div><div class="line">    yield(&quot;cruel&quot;)</div><div class="line">end</div><div class="line"></div><div class="line">x = &quot;Hello&quot;</div><div class="line">my_method &#123;|y| &quot;#&#123;x&#125;, #&#123;y&#125; world&quot; &#125; #  &quot;Hello, cruel world&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>创建代码块时，代码块会获得局部绑定，然后将这两者一起传给一个方法。</p>
</blockquote>
<p>还可以在代码块内定义额外的绑定，但这些绑定在代码块结束时就消失了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def just_yield</div><div class="line">  return yield if block_given?</div><div class="line">end</div><div class="line"></div><div class="line">top_level_variable = 1</div><div class="line"></div><div class="line">just_yield do</div><div class="line">  top_level_variable += 1</div><div class="line">  local_to_block = 1</div><div class="line">  puts local_to_block # =&gt; 1</div><div class="line">end</div><div class="line"></div><div class="line">puts top_level_variable # =&gt; 2</div><div class="line">puts local_to_block</div><div class="line"># =&gt; block_local_vars_failure.rb:24:in `&lt;main&gt;&apos;:</div><div class="line"># undefined local variable or method `local_to_block&apos; for main:Object (NameError)</div></pre></td></tr></table></figure>
<p>基于代码块可以获取局部绑定并一直携带它们的特性，那应该如何使用闭包呢？接下来就要理解作用域了。<strong>局部变量之所以被称为局部变量，也是因为它只在自己的作用域内有效。</strong></p>
<h4 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h4><blockquote>
<p>作用域（scope），程序设计概念，通常来说，一段程序代码中所用到的名字并不总是有效/可用的，而限定这个名字的可用性的代码范围就是这个名字的作用域。</p>
</blockquote>
<p>作用域通过作用域门来划分。程序会在作用域门关闭前一个作用域，同时打开一个新的作用域，作用域门有三处地方：</p>
<p>1.类定义。</p>
<p>2.模块定义。  </p>
<p>3.方法。</p>
<p>切换作用域下面的例子演示了在程序运行时作用域是怎样切换的，它会用Kernel#local_variables()方法来跟踪绑定的名字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">blocks/scopes.rb</div><div class="line">module MyModule    # 作用域门：进入module</div><div class="line">  v1 = 1</div><div class="line">  class MyClass    # 作用域门：进入class</div><div class="line">      v2 = 2    </div><div class="line">      local_variables              #  [:v2]    </div><div class="line">        def my_method     # 作用域门：进入def</div><div class="line">            v3 = 3       </div><div class="line">            local_variables    </div><div class="line">        end    # 作用域门：离开def</div><div class="line">      local_variables              #  [:v2]</div><div class="line">  end  # 作用域门：离开class</div><div class="line">end    # 作用域门：离开module</div><div class="line">obj = MyClass.new</div><div class="line">obj.my_method                   #  [:v3]</div><div class="line">local_variables                 #  [:v1, :obj]</div></pre></td></tr></table></figure>
<p>在一些语言中，比如Java和C#，有“内部作用域（innerscope）”的概念。在内部作用域中可以看到“外部作用域（outerscope）”中的变量。但Ruby中没有这种嵌套式的作用域，它的作用域之间是截然分开的：一旦进入一个新的作用域，原先的绑定就会被替换为一组新的绑定。这意味着在程序进入MyClass后，v1便“超出作用域范围”，从而就不可见了。</p>
<blockquote>
<p>几种变量及其作用域：</p>
<p>全局变量</p>
<p>顶级实例变量</p>
<p>局部变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&gt; class A</div><div class="line">&gt;   $var1 = 2 # =&gt; 全局变量</div><div class="line">&gt;   @var = &quot;the top level variable&quot; # =&gt;顶级实例变量</div><div class="line">&gt;   </div><div class="line">&gt;   def my_method</div><div class="line">&gt;     puts @var</div><div class="line">&gt;     var2 = 3</div><div class="line">&gt;   end</div><div class="line">&gt;   </div><div class="line">&gt;   def my_method1</div><div class="line">&gt;     puts var2</div><div class="line">&gt;     # =&gt; NameError: undefined local variable or method `var2&apos; for</div><div class="line">&gt;     # # &lt;A:0x007ffc8f8bfe00&gt; 在my_method中定义的局部变量不能在my_method1中使用</div><div class="line">&gt;   end</div><div class="line">&gt; end</div><div class="line">&gt;</div><div class="line">&gt; class B</div><div class="line">&gt;   def my_method</div><div class="line">&gt;     puts $var1</div><div class="line">&gt;   end</div><div class="line">&gt;   </div><div class="line">&gt;   def my_method1</div><div class="line">&gt;     puts @var2</div><div class="line">&gt;   end   </div><div class="line">&gt; end</div><div class="line">&gt;</div><div class="line">&gt; a = A.new</div><div class="line">&gt; #=&gt; #&lt;A:0x007ffd08900328&gt;</div><div class="line">&gt; a.my_method</div><div class="line">&gt; # 没有输出，要由main扮演self的角色，才能有用。而这里的self是对象a</div><div class="line">&gt; # 所以去掉classA，直接在irb中运行这段代码才可以输出@var</div><div class="line">&gt;</div><div class="line">&gt; b = B.new</div><div class="line">&gt; #=&gt; #&lt;B:0x007fb62584bb78&gt;</div><div class="line">&gt; b.my_method</div><div class="line">&gt; #=&gt; 2 # 全局变量可以在任何作用域中访问，所以即使$var1定义在A中，B的my_method方法也可以输出它</div><div class="line">&gt;  b.my_method1</div><div class="line">&gt; # 没有输出</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>全局变量的问题在于系统的任何部分都可以修改它们。因此，你会立即发现几乎没法追踪谁把它们改成了什么。正因为如此，基本的原则是：如非必要，尽可能少使用全局变量。</p>
<p>你有时可以用顶级实例变量来代替全局变量，只要main对象在扮演self的角色，就可以访问一个顶级实例变量。但当其他对象成为self时，顶级实例变量就退出作用域了。</p>
</blockquote>
<p>如果希望让一个变量穿越作用域，那么该怎么做呢？要解答这个问题，还是得回到块的主题上。</p>
<h4 id="如何改变作用域的范围？"><a href="#如何改变作用域的范围？" class="headerlink" title="如何改变作用域的范围？"></a>如何改变作用域的范围？</h4><h5 id="1-扁平化作用域："><a href="#1-扁平化作用域：" class="headerlink" title="1.扁平化作用域："></a>1.扁平化作用域：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">my_var = &quot;Success&quot;</div><div class="line">class MyClass    </div><div class="line"># 你希望在这里打印my_var...    </div><div class="line">  def my_method       </div><div class="line">  # ..还有这里    </div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>class这个作用域门。虽然不能让my_var穿越它，但是可以把class关键字替换为某个非作用域门的东西：方法。如果能用方法替换class，就能在一个闭包中获得my_var的值，并把这个闭包传递给该方法。</p>
<p>所以上面的代码可以这样修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">my_var = &quot;Success&quot;</div><div class="line">MyClass = Class.new do</div><div class="line">puts &quot;# 你希望在这里打印 my_var = #&#123;my_var&#125;&quot;</div><div class="line">  define_method :my_method do</div><div class="line">    puts &quot;# ..还有这里 my_var = #&#123;my_var&#125;&quot;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">mc = MyClass.new</div><div class="line">puts mc.my_method</div></pre></td></tr></table></figure>
<p>这里用了<code>Class.new</code>以及<code>define_method</code>实现扁平作用域，从而实现了变量共享。</p>
<blockquote>
<p>扁平化作用域，顾名思义就是把作用域挤压在一起，共享变量。</p>
</blockquote>
<h5 id="2-共享作用域"><a href="#2-共享作用域" class="headerlink" title="2.共享作用域"></a>2.共享作用域</h5><p>假定你想在一组方法之间共享一个变量，但是又不希望其他方法也能访问这个变量，就可以把这些方法定义在那个变量所在的扁平作用域中，这时这个扁平作用域中也叫做共享作用域。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def define_methods    </div><div class="line">	shared = 0    </div><div class="line">	Kernel.send :define_method, :counter do      </div><div class="line">		shared    </div><div class="line">	end    </div><div class="line"></div><div class="line">	Kernel.send :define_method, :inc do |x|       </div><div class="line">		shared += x    </div><div class="line">	end</div><div class="line">end</div><div class="line"></div><div class="line">define_methods</div><div class="line"></div><div class="line">counter         # =&gt;  0</div><div class="line">inc(4)</div><div class="line">counter         # =&gt; 4</div></pre></td></tr></table></figure>
<h4 id="用自己的话整理了改变作用域操作代码块的操作："><a href="#用自己的话整理了改变作用域操作代码块的操作：" class="headerlink" title="用自己的话整理了改变作用域操作代码块的操作："></a>用自己的话整理了改变作用域操作代码块的操作：</h4><h6 id="1-更改一个类中的实例变量"><a href="#1-更改一个类中的实例变量" class="headerlink" title="1.更改一个类中的实例变量"></a>1.更改一个类中的实例变量</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">class MyClass    </div><div class="line">	def initialize       </div><div class="line">		@v = 1    </div><div class="line">	end</div><div class="line">end</div><div class="line"></div><div class="line">obj = MyClass.new  # =&gt; #&lt;MyClass:0x007f93d5852260 @v=1&gt;</div><div class="line">obj.instance_eval do    </div><div class="line">	self             #=&gt; #&lt;MyClass:0x007f93d5852260 @v=1&gt;    </div><div class="line">	@v               #=&gt; 1</div><div class="line">end</div><div class="line"></div><div class="line">v = 2 obj.instance_eval &#123; @v = v &#125;</div><div class="line">obj.instance_eval &#123; @v &#125;            #  2</div></pre></td></tr></table></figure>
<h6 id="2-传递一个块到一个方法中"><a href="#2-传递一个块到一个方法中" class="headerlink" title="2.传递一个块到一个方法中"></a>2.传递一个块到一个方法中</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def a_method(a, b)</div><div class="line">	a + yield(a, b)</div><div class="line">end</div><div class="line"></div><div class="line">a_method(1, 2) &#123;|x, y| (x + y) * 3 &#125;  #=&gt;  10</div></pre></td></tr></table></figure>
<p>这里就把<code>{|x, y| (x + y) * 3 }</code>传递到<code>a_method</code>方法中，然后用<code>yield</code>求出程序的最终结果。</p>
<h6 id="3-传递一个块的结果到一个到另一个块中"><a href="#3-传递一个块的结果到一个到另一个块中" class="headerlink" title="3.传递一个块的结果到一个到另一个块中"></a>3.传递一个块的结果到一个到另一个块中</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">class CleanRoom</div><div class="line">  def current_temperature</div><div class="line">    19</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">cr = CleanRoom.new</div><div class="line">cr.instance_eval do</div><div class="line">  if current_temperature &lt; 20</div><div class="line">    puts &quot;wear jacket&quot;</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>但是instance_eval无法传递参数，要改用instance_exec，下面的例子比较了它们之间的区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">class C</div><div class="line">  def initialize</div><div class="line">    @x = 1</div><div class="line">  end</div><div class="line"></div><div class="line">  def my_method</div><div class="line">    @x</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">class D</div><div class="line">  def twisted_method</div><div class="line">    @y = 2</div><div class="line">    C.new.instance_eval &#123; &quot;@x: #&#123;@x&#125;, @y: #&#123;@y&#125;&quot; &#125;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">puts D.new.twisted_method</div><div class="line"># =&gt; @x: 1, @y:</div><div class="line"></div><div class="line"># 把instance_eval换成instance_exec</div><div class="line">class D</div><div class="line">  def twisted_method</div><div class="line">    @y = 2</div><div class="line">    C.new.instance_exec(@y) &#123; |y| &quot;@x: #&#123;@x&#125;, @y: #&#123;y&#125;&quot; &#125;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">puts D.new.twisted_method</div><div class="line"># =&gt; @x: 1, @y: 2</div></pre></td></tr></table></figure>
<h4 id="剖析代码块的底层"><a href="#剖析代码块的底层" class="headerlink" title="剖析代码块的底层"></a>剖析代码块的底层</h4><h5 id="从底层看，使用代码块分为两步，一是将代码块打包备用，二是是执行被打包的代码。"><a href="#从底层看，使用代码块分为两步，一是将代码块打包备用，二是是执行被打包的代码。" class="headerlink" title="从底层看，使用代码块分为两步，一是将代码块打包备用，二是是执行被打包的代码。"></a>从底层看，使用代码块分为两步，一是将代码块打包备用，二是是执行被打包的代码。</h5><p>这些打包备用的东西就是可调用对象：</p>
<p>1.块</p>
<p>2.使用proc。proc基本上就是一个由块转换成的对象。</p>
<p>3.使用lambda。它是proc的近亲。</p>
<p>4.使用方法。</p>
<h5 id="Proc对象"><a href="#Proc对象" class="headerlink" title="Proc对象"></a>Proc对象</h5><p>尽管Ruby中绝大多数东西都是对象，但是块不是。为什么要关心这个呢？设想希望存储[一个块供以后执行]，这时，你需要一个对象才能做到。Bill说道，“为了解决这个问题，Ruby在标准库中提供了名为Proc的类。”一个Proc就是一个转换成对象的块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">inc = Proc.new &#123;|x| x + 1 &#125;</div><div class="line"># 更多...</div><div class="line">inc.call(2) #=&gt;3</div></pre></td></tr></table></figure>
<p>这种先打包代码，以后调用的技术称为延迟执行（Deferred Evaluation）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dec = lambda &#123;|x| x - 1 &#125;</div><div class="line">dec.class #=&gt;Proc</div><div class="line">dec.call(2) #=&gt;1</div></pre></td></tr></table></figure>
<h5 id="amp-操作符"><a href="#amp-操作符" class="headerlink" title="&amp;操作符"></a>&amp;操作符</h5><p>&amp;操作符能把代码块传递给另一个方法或者代码块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 这里&#123; |x, y| x * y &#125;就被当成&amp;operation参数传递给do_math方法，随后再被传递给math方法</div><div class="line">def math(a, b)</div><div class="line">  yield(a, b)</div><div class="line">end</div><div class="line"></div><div class="line">def do_math(a, b, &amp;operation)</div><div class="line">  math(a, b, &amp;operation)</div><div class="line">end</div><div class="line"></div><div class="line"># puts do_math(2, 3)&#123; |x, y| x * y &#125;</div><div class="line">puts do_math(2, 3) #=&gt; wrong</div></pre></td></tr></table></figure>
<p>&amp;操作符会把proc对象my_proc转换为块，再把这个块传给这个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">def my_method(greeting)</div><div class="line">	puts &quot;#&#123;greeting&#125;, #&#123;yield&#125;!&quot;</div><div class="line">end</div><div class="line"></div><div class="line">my_proc = proc &#123; &quot;Bill&quot; &#125;</div><div class="line">my_method(&quot;Hello&quot;, &amp;my_proc)</div></pre></td></tr></table></figure>
<h5 id="Proc和lambda的区别"><a href="#Proc和lambda的区别" class="headerlink" title="Proc和lambda的区别:"></a>Proc和lambda的区别:</h5><h6 id="1-对return的处理不同。"><a href="#1-对return的处理不同。" class="headerlink" title="1.对return的处理不同。"></a>1.对return的处理不同。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">def double(callable_object)    </div><div class="line">	callable_object.call * 2</div><div class="line">end</div><div class="line"></div><div class="line">l = lambda &#123; return 10 &#125;</div><div class="line">double(l) #  20</div><div class="line"></div><div class="line">p = Proc.new &#123; return 10 &#125;</div><div class="line"># 这会失败，并产生一个LocalJumpError错误:</div><div class="line"># double(p)</div></pre></td></tr></table></figure>
<h6 id="2-对参数检查的容忍度不同。"><a href="#2-对参数检查的容忍度不同。" class="headerlink" title="2.对参数检查的容忍度不同。"></a>2.对参数检查的容忍度不同。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">p = Proc.new&#123; |a, b| [a, b] &#125;</div><div class="line">p.arity #=&gt; 2</div><div class="line">p.call(1,2,3)  #=&gt; [1, 2]</div><div class="line">p.call(1)  #=&gt; [1, nil]</div></pre></td></tr></table></figure>
<p><code>proc</code>根据实际参数的数量自动调整输出结果。再来看<code>lambda</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ld = lambda&#123; |a, b| [a, b] &#125;</div><div class="line">ld.arity #=&gt; 2</div><div class="line">ld.call(1,2,3)  #=&gt; ArgumentError: wrong number of arguments (given 3, expected 2)</div><div class="line">ld.call(1)  #=&gt; ArgumentError: wrong number of arguments (given 1, expected 2)</div></pre></td></tr></table></figure>
<p>如果参数个数不恰好是两个，就会报错。</p>
<h5 id="方法也是一个可调用对象："><a href="#方法也是一个可调用对象：" class="headerlink" title="方法也是一个可调用对象："></a>方法也是一个可调用对象：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">blocks/methods.rb</div><div class="line">class MyClass    </div><div class="line">	def initialize(value)       </div><div class="line">		@x = value    </div><div class="line">	end    </div><div class="line"></div><div class="line">	def my_method       </div><div class="line">		@x    </div><div class="line">	end</div><div class="line">end</div><div class="line"></div><div class="line">object = MyClass.new(1)</div><div class="line">m = object.method :my_method</div><div class="line">m.call                               =&gt;    # 1</div></pre></td></tr></table></figure>
<h4 id="这章知识的运用："><a href="#这章知识的运用：" class="headerlink" title="这章知识的运用："></a>这章知识的运用：</h4><p>开发一个DSL语言，进行几次重构，使代码质量不断进阶：</p>
<p>1.作用域共享</p>
<p>2.变量不要胡乱地散落在顶级作用域里</p>
<p>3.把事件触发条件从代码块转换成proc</p>
<p>4.消灭全局变量，使用共享作用域</p>
<p>5.增加洁净室</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://peckliu2017.github.io/2017/09/19/Ruby元编程笔记——-方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peck Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Writing and Thinking">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/19/Ruby元编程笔记——-方法/" itemprop="url">Ruby元编程笔记—— 方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-19T19:10:04+08:00">
                2017-09-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在理解了方法查找的基础上，可以在运行时创建方法、插入方法调用、把调用转发给其他对象，甚至调用一个不存在的方法。接下来的元编程技术讲解了如何实现这些操作。</p>
<h4 id="本章的主要内容："><a href="#本章的主要内容：" class="headerlink" title="本章的主要内容："></a>本章的主要内容：</h4><p>通过元编程技术使代码更加简洁，更有利于扩展和维护。</p>
<p>先来看一段代码，通过重构的过程，逐步了解元编程怎样发挥作用。</p>
<ol>
<li>这是一个连接数据库并查询相关信息的<code>data_source</code>类。为节省时间，可直接跳到第三步重构步骤，需要时再跳回来看。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">class DS</div><div class="line">  # attr_accessor :workstation_id</div><div class="line"></div><div class="line">  def initialize</div><div class="line">    &quot;...connect...&quot;</div><div class="line">  end</div><div class="line"></div><div class="line">  def get_cpu_info(workstation_id)</div><div class="line">    cpu_info = if workstation_id == 1</div><div class="line">      &quot;intel core i7&quot;</div><div class="line">    else workstation_id == 2</div><div class="line">      &quot;apple AM 11&quot;</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def get_cpu_price(workstation_id)</div><div class="line">    cpu_price = if workstation_id == 1</div><div class="line">      2500</div><div class="line">    else workstation_id == 2</div><div class="line">      2000</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def get_mouse_info(workstation_id)</div><div class="line">    mouse_info = if workstation_id == 1</div><div class="line">      &quot;雷蛇&quot;</div><div class="line">    else workstation_id == 2</div><div class="line">      &quot;牧马人&quot;</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def get_mouse_price(workstation_id)</div><div class="line">    mouse_price = if workstation_id == 1</div><div class="line">      300</div><div class="line">    else workstation_id == 2</div><div class="line">      500</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def get_keyboard_info(workstation_id)</div><div class="line">    keyboard_info = if workstation_id == 1</div><div class="line">      &quot;机械键盘&quot;</div><div class="line">    else workstation_id == 2</div><div class="line">      &quot;普通键盘&quot;</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  def get_keyboard_price(workstation_id)</div><div class="line">    keyboard_price = if workstation_id == 1</div><div class="line">      500</div><div class="line">    else workstation_id == 2</div><div class="line">      90</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<ol>
<li>这是一个<code>computer</code>类。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">require &apos;./data_source.rb&apos;</div><div class="line">class Computer</div><div class="line">  def initialize(computer_id, data_source)</div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">  end</div><div class="line"></div><div class="line">  def mouse</div><div class="line">    info = @data_source.get_mouse_info(@id)</div><div class="line">    price = @data_source.get_mouse_price(@id)</div><div class="line">    result = &quot;Mouse: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">    return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">  end</div><div class="line"></div><div class="line">  def cpu</div><div class="line">    info = @data_source.get_cpu_info(@id)</div><div class="line">    price = @data_source.get_cpu_price(@id)</div><div class="line">    result = &quot;Cpu: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">    return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">  end</div><div class="line"></div><div class="line">  def keyboard</div><div class="line">    info = @data_source.get_keyboard_info(@id)</div><div class="line">    price = @data_source.get_keyboard_price(@id)</div><div class="line">    result = &quot;Keyboard: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">    return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line"></div><div class="line">computer = Computer.new(1,DS.new)</div><div class="line">puts computer.mouse</div><div class="line">puts computer.cpu</div><div class="line">puts computer.keyboard</div></pre></td></tr></table></figure>
<ol>
<li>现在我们使用元编程的技术对<code>Computer</code>类增加<strong>动态派发</strong>，进行第一次重构：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">require &apos;./data_source.rb&apos;</div><div class="line">class Computer</div><div class="line">  def initialize(computer_id, data_source)</div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">  end</div><div class="line"></div><div class="line">  def mouse</div><div class="line">    component :mouse</div><div class="line">  end</div><div class="line"></div><div class="line">  def cpu</div><div class="line">    component :cpu</div><div class="line">  end</div><div class="line"></div><div class="line">  def keyboard</div><div class="line">    component :keyboard</div><div class="line">  end</div><div class="line"></div><div class="line">  def component(name)</div><div class="line">    info = @data_source.send &quot;get_#&#123;name&#125;_info&quot;, @id</div><div class="line">    price = @data_source.send &quot;get_#&#123;name&#125;_price&quot;, @id</div><div class="line">    result = &quot;#&#123;name.capitalize&#125;: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">    return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">computer = Computer.new(2,DS.new)</div><div class="line">puts computer.mouse</div><div class="line">puts computer.cpu</div><div class="line">puts computer.keyboard</div></pre></td></tr></table></figure>
<p>首先把重复的代码提取到一个方法中，然后把<code>mouse</code>，<code>cpu</code>，<code>keyboard</code>方法代理到<code>component</code>方法上。<code>component</code>方法会接着调用DS类的<code>get_XXX_info</code>和<code>get_XXX_price</code>方法。然后执行相关操作。</p>
<p>现在重复代码被消灭了很多，但仍然可以进一步精简。</p>
<blockquote>
<p>什么是动态派发？</p>
<p>在代码运行的最后一刻再决定调用哪个方法，被称为动态派发。比如@data<em>source.send “get</em>#{name}_info”, @id的使用。</p>
</blockquote>
<ol>
<li>现在我们使用<code>define_method</code>方法来动态创建方法，以进行第二次重构：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">require &apos;./data_source.rb&apos;</div><div class="line">class Computer</div><div class="line">  def initialize(computer_id, data_source)</div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">  end</div><div class="line"></div><div class="line">  def self.define_component(name)</div><div class="line">    define_method(name) do</div><div class="line">      info = @data_source.send &quot;get_#&#123;name&#125;_info&quot;, @id</div><div class="line">      price = @data_source.send &quot;get_#&#123;name&#125;_price&quot;, @id</div><div class="line">      result = &quot;#&#123;name.capitalize&#125;: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">      return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">    end</div><div class="line">  end</div><div class="line"></div><div class="line">  define_component :mouse  # 调用第一次创建mouse方法</div><div class="line">  define_component :cpu   # 调用第二次创建cpu方法</div><div class="line">  define_component :keyboard   # 调用第三次创建keyboard方法</div><div class="line">end</div><div class="line"></div><div class="line">computer = Computer.new(2,DS.new)</div><div class="line">puts computer.mouse</div><div class="line">puts computer.cpu</div><div class="line">puts computer.keyboard</div></pre></td></tr></table></figure>
<p><code>define_method</code>可以代替<code>def</code>关键字定义方法，这次重构中，<code>self.define_component(name)</code>方法执行了三次，每一次又都调用<code>define_method</code>分别创建了<code>mouse</code> ，<code>cpu</code>，<code>keyboard</code>方法。然后执行相关操作。</p>
<blockquote>
<p>这三个在<strong>运行时被定义的方法被称为动态方法。</strong></p>
</blockquote>
<p>接下来又有一个<strong>关于代码维护和拓展的问题</strong>：如果将来DS类中加入了<code>get_display_info</code>方法，而<code>Computer</code>类中并没有动态派发这个方法，能不能在不修改<code>Computer</code>代码的基础上，自动将<code>get_display_info</code>方法加入到<code>Computer</code>的动态派发中呢？</p>
<ol>
<li>用内省的方式第三次重构：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">require &apos;./data_source.rb&apos;</div><div class="line">class Computer</div><div class="line">  def initialize(computer_id, data_source)</div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">    data_source.methods.grep(/^get_(.*)_info$/)&#123; Computer.define_component $1 &#125;</div><div class="line">  end</div><div class="line"></div><div class="line">  def self.define_component(name)</div><div class="line">    define_method(name) do</div><div class="line">      info = @data_source.send &quot;get_#&#123;name&#125;_info&quot;, @id</div><div class="line">      price = @data_source.send &quot;get_#&#123;name&#125;_price&quot;, @id</div><div class="line">      result = &quot;#&#123;name.capitalize&#125;: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">      return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line"></div><div class="line">computer = Computer.new(2,DS.new)</div><div class="line">puts computer.mouse</div><div class="line">puts computer.cpu</div><div class="line">puts computer.keyboard</div></pre></td></tr></table></figure>
<p>这次重构中新加入的<code>data_source.methods.grep(/^get_(.*)_info$/){ Computer.define_component $1 }</code>的作用如下：</p>
<p>当程序执行到<code>puts computer.mouse</code>时，会去<code>Computer</code>类中去找<code>mouse</code>方法，在<code>initialize</code>中，<code>data_source.methods.grep(/^get_(.*)_info$/)</code>如果找到<code>get_mouse_info</code>方法就会用<code>mouse</code>作为参数传给<code>Computer.define_component</code>，随后<code>Computer.define_component</code>会创建<code>mouse</code>方法。</p>
<p>上面的三次重构用到了<strong>动态派发</strong>和<strong>动态方法</strong>的技术。接下来是运用幽灵方法和动态代理来解决代码重构的问题。</p>
<ol>
<li>第四次重构：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">require &apos;./data_source.rb&apos;</div><div class="line">class Computer</div><div class="line">  def initialize(computer_id, data_source)</div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">  end</div><div class="line"></div><div class="line">  def method_missing(name)</div><div class="line">    super if !@data_source.respond_to?(&quot;get_#&#123;name&#125;_info&quot;)</div><div class="line">    info = @data_source.send &quot;get_#&#123;name&#125;_info&quot;, @id</div><div class="line">    price = @data_source.send &quot;get_#&#123;name&#125;_price&quot;, @id</div><div class="line">    result = &quot;#&#123;name.capitalize&#125;: #&#123;info&#125; #&#123;price&#125;&quot;</div><div class="line">    return &quot;#&#123;result&#125;&quot; if price &gt;= 100</div><div class="line">  end</div><div class="line"></div><div class="line">  def respond_to_missing?(method, include_private = false)</div><div class="line">    @data_source.respond_to?(&quot;get_#&#123;method&#125;_info&quot;) || super</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line"></div><div class="line">computer = Computer.new(2,DS.new)</div><div class="line">puts computer.mouse</div><div class="line">puts computer.cpu</div><div class="line">puts computer.keyboard</div><div class="line">puts computer.respond_to?(:mouse)</div></pre></td></tr></table></figure>
<p>当程序执行到<code>puts computer.mouse</code>时，因为computer中没有直接定义<code>mouse</code>方法，所以会调用<code>method_missing</code>方法，如果在@data_source中找到了get_mouse_info，就会用<code>mouse</code>作为参数动态派发<code>get_mouse_info</code>和<code>get_mouse_price</code>执行相应程序返回相应结果。</p>
<blockquote>
<p>什么叫幽灵方法？</p>
<p><code>method_missing</code> 被称作幽灵方法，它可以动态地创建方法。</p>
<p>什么叫动态代理？</p>
<p>一个捕获幽灵方法调用并把它们转发给另外一个对象的对象（有时也会在转发前后包装一些自己的逻辑，在这里指自己重写的method_missing方法），称为动态代理（Dynamic Proxy）。</p>
</blockquote>
<h5 id="当一个幽灵方法和一个真实方法发生名字冲突时"><a href="#当一个幽灵方法和一个真实方法发生名字冲突时" class="headerlink" title="当一个幽灵方法和一个真实方法发生名字冲突时"></a>当一个幽灵方法和一个真实方法发生名字冲突时</h5><p>这个问题是动态代理技术的通病，当一个幽灵方法和一个真实方法发生名字冲突时，后者会胜出。为了解决这个问题，你可以通过继承白板类和删除重名方法的方法来定义方法。<br>继承白板类:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">class XXX &lt; BasicObject</div></pre></td></tr></table></figure>
<p>删除重名方法:</p>
<p>可以使用<code>Module#undef_method()</code>方法，它会删除所有的（包括继承来的）方法；也可以使用<code>Module#remove_method()</code>方法，它只会删除接收者自己的方法，而保留继承来的方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://peckliu2017.github.io/2017/04/02/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peck Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Writing and Thinking">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/02/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-02T03:37:02+08:00">
                2017-04-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Peck Liu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Peck Liu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  








  












  





  

  

  

  
  

  

  

  

</body>
</html>
